name: Decompile Marshal

on:
  workflow_dispatch:

jobs:
  decompile:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup Python 3.10 (uncompyle6 works here)
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install decompiler tools
      run: |
        pip install decompyle3
        pip install uncompyle6

    - name: Show repository files
      run: ls -R .

    - name: Run decompiler
      run: |
        python3 << 'EOF'
        import marshal, io, sys
        from pathlib import Path

        file = Path("final_payload.marshal")
        data = file.read_bytes()
        co = marshal.loads(data)

        # Try decompyle3 first
        try:
            from decompyle3.main import decompile
            buf = io.StringIO()
            decompile(None, None, co, buf)
            output = buf.getvalue()
        except Exception as e:
            # Fallback to uncompyle6
            import uncompyle6
            buf = io.StringIO()
            uncompyle6.deparse_code2str(co, buf)
            output = buf.getvalue()

        Path("decompiled_payload.py").write_text(output)
        print("DONE!")
        EOF

    - name: Upload Decompiled Result
      uses: actions/upload-artifact@v4
      with:
        name: decompiled_payload
        path: decompiled_payload.py
